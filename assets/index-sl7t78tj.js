(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const h of document.querySelectorAll('link[rel="modulepreload"]'))i(h);new MutationObserver(h=>{for(const e of h)if(e.type==="childList")for(const r of e.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function s(h){const e={};return h.integrity&&(e.integrity=h.integrity),h.referrerPolicy&&(e.referrerPolicy=h.referrerPolicy),h.crossOrigin==="use-credentials"?e.credentials="include":h.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function i(h){if(h.ep)return;h.ep=!0;const e=s(h);fetch(h.href,e)}})();class T{constructor(){this.keys={},this.joystick={x:0,y:0,active:!1},this.chargeActive=!1,this.setupKeyboard(),this.setupTouch()}setupKeyboard(){window.addEventListener("keydown",t=>{this.keys[t.code]=!0,t.code==="Space"&&(this.chargeActive=!0)}),window.addEventListener("keyup",t=>{this.keys[t.code]=!1,t.code==="Space"&&(this.chargeActive=!1)})}setupTouch(){const t=document.getElementById("joystick-zone"),s=document.getElementById("action-button");let i,h;const e=(a,c)=>{i=a,h=c,this.joystick.active=!0,this.updateJoystickVisual(0,0)},r=(a,c)=>{if(!this.joystick.active)return;const l=a-i,x=c-h,M=Math.sqrt(l*l+x*x),y=40,p=Math.atan2(x,l),w=Math.min(M,y),v=Math.cos(p)*w,m=Math.sin(p)*w;this.joystick.x=v/y,this.joystick.y=m/y,this.updateJoystickVisual(v,m)},n=()=>{this.joystick.active=!1,this.joystick.x=0,this.joystick.y=0,this.updateJoystickVisual(0,0)};t.addEventListener("touchstart",a=>{a.preventDefault();const c=a.touches[0];e(c.clientX,c.clientY)}),t.addEventListener("touchmove",a=>{a.preventDefault();const c=a.touches[0];r(c.clientX,c.clientY)}),t.addEventListener("touchend",a=>{a.preventDefault(),n()}),t.addEventListener("mousedown",a=>{a.preventDefault(),e(a.clientX,a.clientY)}),window.addEventListener("mousemove",a=>{this.joystick.active&&(a.preventDefault(),r(a.clientX,a.clientY))}),window.addEventListener("mouseup",a=>{this.joystick.active&&(a.preventDefault(),n())});const d=a=>{a.cancelable&&a.preventDefault(),this.chargeActive=!0},f=a=>{a.cancelable&&a.preventDefault(),this.chargeActive=!1};s.addEventListener("touchstart",d),s.addEventListener("touchend",f),s.addEventListener("mousedown",d),s.addEventListener("mouseup",f),s.addEventListener("mouseleave",f)}updateJoystickVisual(t,s){let i=document.querySelector(".joystick-knob");i||(i=document.createElement("div"),i.className="joystick-knob",document.getElementById("joystick-zone").appendChild(i)),i.style.transform=`translate(calc(-50% + ${t}px), calc(-50% + ${s}px))`}getMovement(){let t=0,s=0;if((this.keys.ArrowLeft||this.keys.KeyA)&&(t-=1),(this.keys.ArrowRight||this.keys.KeyD)&&(t+=1),(this.keys.ArrowUp||this.keys.KeyW)&&(s-=1),(this.keys.ArrowDown||this.keys.KeyS)&&(s+=1),t!==0||s!==0){const i=Math.sqrt(t*t+s*s);t/=i,s/=i}return this.joystick.active&&(t=this.joystick.x,s=this.joystick.y),{x:t,y:s}}}class C{constructor(t,s,i){this.ctx=t,this.width=s,this.height=i}resize(t,s){this.width=t,this.height=s}clear(){this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle="#0d0d0d",this.ctx.fillRect(0,0,this.width,this.height)}drawPlayer(t){if(this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.shadowBlur=20,this.ctx.shadowColor=t.color,this.ctx.fillStyle=t.invincible?`hsl(${Date.now()%360}, 100%, 50%)`:t.color,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.fill(),t.isShaking&&(this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius+8,0,Math.PI*2),this.ctx.stroke()),t.def>3&&(this.ctx.strokeStyle="#ffff00",this.ctx.lineWidth=2+(t.def-3),this.ctx.beginPath(),this.ctx.arc(0,0,t.radius+5+t.def,0,Math.PI*2),this.ctx.stroke()),t.atk>3){this.ctx.fillStyle="#ff0055";const s=t.atk;for(let i=0;i<s;i++){const h=Math.PI*2/s*i,e=Math.cos(h)*(t.radius+10),r=Math.sin(h)*(t.radius+10);this.ctx.beginPath(),this.ctx.arc(e,r,5,0,Math.PI*2),this.ctx.fill()}}if(t.isCharging&&(this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius+5,0,Math.PI*2),this.ctx.stroke()),t.hasSword){const s=Math.cos(t.swordAngle)*t.swordRadius,i=Math.sin(t.swordAngle)*t.swordRadius;this.ctx.save(),this.ctx.translate(s,i),this.ctx.rotate(t.swordAngle+Math.PI/2),this.ctx.fillStyle="#ffaa00",this.ctx.shadowBlur=15,this.ctx.shadowColor="#ffaa00",this.ctx.beginPath(),this.ctx.moveTo(0,-20),this.ctx.lineTo(5,0),this.ctx.lineTo(0,20),this.ctx.lineTo(-5,0),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore()}this.ctx.restore()}drawBlock(t){if(this.ctx.fillStyle=t.color,this.ctx.fillRect(t.x,t.y,t.width,t.height),this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.strokeRect(t.x,t.y,t.width,t.height),t.hp<t.maxHp){const s=1-t.hp/t.maxHp;this.ctx.strokeStyle="#000",this.ctx.lineWidth=2,this.ctx.beginPath(),s>.3&&(this.ctx.moveTo(t.x+10,t.y+10),this.ctx.lineTo(t.x+t.width/2,t.y+t.height/2)),s>.6&&(this.ctx.moveTo(t.x+t.width-10,t.y+10),this.ctx.lineTo(t.x+t.width/2,t.y+t.height/2)),s>.8&&(this.ctx.moveTo(t.x+t.width/2,t.y+t.height-10),this.ctx.lineTo(t.x+t.width/2,t.y+t.height/2)),this.ctx.stroke()}}drawItem(t){this.ctx.save(),this.ctx.translate(t.x,t.y);const s=1+Math.sin(t.pulse)*.1;if(this.ctx.scale(s,s),this.ctx.fillStyle=t.color,this.ctx.shadowBlur=10,this.ctx.shadowColor=t.color,t.type==="atk"){this.ctx.beginPath();for(let i=0;i<5;i++)this.ctx.lineTo(Math.cos((18+i*72)*Math.PI/180)*t.radius,Math.sin((18+i*72)*Math.PI/180)*t.radius),this.ctx.lineTo(Math.cos((54+i*72)*Math.PI/180)*(t.radius/2),Math.sin((54+i*72)*Math.PI/180)*(t.radius/2));this.ctx.closePath(),this.ctx.fill()}else if(t.type==="spd")this.ctx.beginPath(),this.ctx.moveTo(5,-t.radius),this.ctx.lineTo(-5,0),this.ctx.lineTo(5,0),this.ctx.lineTo(-5,t.radius),this.ctx.closePath(),this.ctx.fill();else if(t.type==="hp")this.ctx.beginPath(),t.radius*.3,this.ctx.moveTo(0,t.radius*.3),this.ctx.bezierCurveTo(0,-t.radius*.5,-t.radius,-t.radius*.5,-t.radius,t.radius*.3),this.ctx.bezierCurveTo(-t.radius,t.radius*.8,0,t.radius,0,t.radius),this.ctx.bezierCurveTo(0,t.radius,t.radius,t.radius*.8,t.radius,t.radius*.3),this.ctx.bezierCurveTo(t.radius,-t.radius*.5,0,-t.radius*.5,0,t.radius*.3),this.ctx.fill();else if(t.type==="invincible"){this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.beginPath();for(let i=0;i<3;i++)this.ctx.arc(0,0,t.radius*(i+1)/3,0,Math.PI*2*.8);this.ctx.stroke()}else t.type==="beam"?(this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.stroke(),this.ctx.stroke(),this.ctx.fillRect(-2,-t.radius,4,t.radius*2)):t.type==="sword"?(this.ctx.fillStyle=t.color,this.ctx.beginPath(),this.ctx.moveTo(0,-t.radius),this.ctx.lineTo(t.radius/3,0),this.ctx.lineTo(0,t.radius),this.ctx.lineTo(-t.radius/3,0),this.ctx.closePath(),this.ctx.fill()):(this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.fill());this.ctx.restore()}drawBoss(t){this.ctx.fillStyle=t.color,this.ctx.fillRect(t.x,t.y,t.width,t.height),this.ctx.fillStyle="red",this.ctx.fillRect(t.x,t.y-10,t.width,5),this.ctx.fillStyle="green",this.ctx.fillRect(t.x,t.y-10,t.width*(t.hp/t.maxHp),5)}drawProjectile(t){if(this.ctx.save(),this.ctx.shadowBlur=10,this.ctx.shadowColor=t.color,t.type==="boss_bullet")this.ctx.fillStyle=t.color,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.radius,0,Math.PI*2),this.ctx.fill();else if(t.type==="homing_missile"){this.ctx.fillStyle=t.color;const s=Math.atan2(t.vy,t.vx);this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(s),this.ctx.beginPath(),this.ctx.moveTo(10,0),this.ctx.lineTo(-5,5),this.ctx.lineTo(-5,-5),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore()}else this.ctx.fillStyle=t.type==="beam"?"#00f0ff":"#ff0055",this.ctx.fillRect(t.x-t.width/2,t.y-t.height/2,t.width,t.height);this.ctx.restore()}drawFloatingText(t){this.ctx.save(),this.ctx.globalAlpha=Math.max(0,t.life),this.ctx.fillStyle=t.color,this.ctx.font="bold 20px Inter",this.ctx.textAlign="center",this.ctx.fillText(t.text,t.x,t.y),this.ctx.restore()}}class k{constructor(t,s){this.x=t,this.y=s,this.radius=20,this.atkCount=0,this.spdCount=0,this.defCount=0,this.hp=100,this.baseSpeed=400,this.baseAtk=5,this.baseDef=1,this.baseColor="#00f0ff",this.color=this.baseColor,this.isCharging=!1,this.hasBeam=!1,this.chargePower=0,this.isAttacking=!1,this.attackTimer=0,this.invincible=!1,this.invincibleTimer=0,this.chargeDirection={x:0,y:-1},this.lastX=t,this.shakeCount=0,this.shakeTimer=0,this.isShaking=!1,this.weaponTimer=0,this.hasSword=!1,this.swordAngle=0,this.swordRadius=60,this.swordSize=20}get speed(){let t=this.baseSpeed*Math.pow(1.1,this.spdCount);return this.invincible&&(t*=2),t}get atk(){return this.baseAtk*Math.pow(1.3,this.atkCount)}get def(){return this.baseDef*Math.pow(1.2,this.defCount)}get canBreakOnContact(){return this.atkCount>=5}upgrade(t){switch(t){case"atk":this.atkCount++;break;case"spd":this.spdCount++;break;case"def":this.defCount++;break;case"hp":this.hp=Math.min(this.hp+20,100);break;case"beam":this.hasBeam=!0;break;case"sword":this.hasSword=!0;break}}update(t,s){if(this.invincible&&(this.invincibleTimer-=t,this.invincibleTimer<=0&&(this.invincible=!1)),this.hasBeam){if(s.chargeActive?(this.isAttacking=!0,this.isCharging=!1):this.isAttacking=!1,!this.isCharging){const i=s.getMovement(),h=this.isAttacking?this.speed*.5:this.speed;this.x+=i.x*h*t,this.y+=i.y*h*t}}else{if(s.chargeActive){this.isCharging=!0,this.chargePower+=t*5,this.chargePower=Math.min(this.chargePower,20);const i=this.chargePower/20,h=Math.floor(255*i),e=Math.floor(240*(1-i)),r=255;this.color=`rgb(${h}, ${e}, ${r})`}else{if(this.isCharging){const i=s.getMovement();if(i.x!==0||i.y!==0){const h=Math.sqrt(i.x*i.x+i.y*i.y);this.chargeDirection={x:i.x/h,y:i.y/h}}else this.chargeDirection={x:0,y:-1};this.isCharging=!1,this.isAttacking=!0,this.attackTimer=.5,this.chargePower=Math.max(1,this.chargePower)}this.invincible||(this.color=this.baseColor)}if(this.isAttacking)if(this.attackTimer-=t,this.attackTimer<=0)this.isAttacking=!1,this.chargePower=0;else{const i=500+this.chargePower*50;this.x+=this.chargeDirection.x*i*t,this.y+=this.chargeDirection.y*i*t}else if(!this.isCharging){const i=s.getMovement();this.shakeTimer+=t,this.shakeTimer>.2&&(this.shakeCount=0,this.shakeTimer=0),Math.sign(i.x)!==Math.sign(this.lastX-this.x)&&Math.abs(i.x)>.8&&(this.shakeCount++,this.shakeTimer=0),this.lastX=this.x,this.shakeCount>3?this.isShaking=!0:this.isShaking=!1,this.x+=i.x*this.speed*t,this.y+=i.y*this.speed*t}}this.hasSword&&(this.swordAngle+=t*5),this.x=Math.max(this.radius,Math.min(window.innerWidth-this.radius,this.x)),this.y=Math.max(this.radius,Math.min(window.innerHeight-this.radius,this.y))}}class P{constructor(t,s,i,h,e="normal"){this.x=t,this.y=s,this.width=i,this.height=h,this.type=e,this.active=!0,this.hp=(e==="hard"?3:1)*10,this.maxHp=this.hp,this.color=this.getColorByType(e)}getColorByType(t){switch(t){case"hard":return"#ff0055";case"resource":return"#00ff00";default:return"#aaaaaa"}}update(t,s){this.y+=s*t}}class B{constructor(t,s,i){this.x=t,this.y=s,this.radius=15,this.type=i,this.active=!0,this.color=this.getColorByType(i),this.pulse=0}getColorByType(t){switch(t){case"atk":return"#ff0055";case"spd":return"#ffff00";case"def":return"#0055ff";case"hp":return"#ff00ff";case"invincible":return"#ffffff";case"beam":return"#00f0ff";case"sword":return"#ffaa00";default:return"#aaaaaa"}}update(t,s){this.y+=s*t,this.pulse+=t*5}}class S{constructor(t,s){this.x=t,this.y=s,this.width=100,this.height=100,this.hp=1e3,this.maxHp=1e3,this.active=!0,this.color="#ff0000",this.state="idle",this.timer=0,this.attackTimer=0,this.attackCooldown=2,this.missileTimer=0,this.missileCooldown=5,this.missileBurstCount=0,this.missileBurstTimer=0,this.isFiringMissiles=!1,this.projectilesQueue=[]}update(t,s){this.timer+=t,this.attackTimer+=t,this.missileTimer+=t;const i=s.x-(this.x+this.width/2);Math.abs(i)>10&&(this.x+=Math.sign(i)*100*t),this.y=50+Math.sin(this.timer*2)*20,this.missileTimer>this.missileCooldown&&(this.isFiringMissiles=!0,this.missileTimer=0,this.missileBurstCount=0,this.missileBurstTimer=0),this.isFiringMissiles&&(this.missileBurstTimer-=t,this.missileBurstTimer<=0&&(this.fireMissileBurst(),this.missileBurstCount++,this.missileBurstTimer=.5,this.missileBurstCount>=3&&(this.isFiringMissiles=!1)))}fireMissileBurst(){this.projectilesQueue.push({x:this.x,y:this.y+this.height/2,vx:-150,vy:50,type:"homing_missile"}),this.projectilesQueue.push({x:this.x+this.width,y:this.y+this.height/2,vx:150,vy:50,type:"homing_missile"})}pollProjectiles(){const t=[...this.projectilesQueue];return this.projectilesQueue=[],t}shouldAttack(){return this.attackTimer>=this.attackCooldown?(this.attackTimer=0,!0):!1}getAttackProjectile(t,s){const i=this.x+this.width/2,h=this.y+this.height/2,e=t-i,r=s-h,n=Math.sqrt(e*e+r*r),d=400,f=e/n*d,a=r/n*d;return{x:i,y:h,vx:f,vy:a}}}class g{constructor(t,s,i,h,e){this.x=t,this.y=s,this.vx=i,this.vy=h,this.type=e,this.active=!0,this.width=e==="beam"?20:10,this.height=e==="beam"?40:10,this.radius=e==="boss_bullet"||e==="homing_missile"?8:5,e==="boss_bullet"?this.color="#ff0055":e==="homing_missile"?this.color="#ffaa00":this.color="#fff"}update(t,s=null){if(this.type==="homing_missile"&&s){const e=s.x-this.x,r=s.y-this.y,n=Math.sqrt(e*e+r*r);if(n>0){const d=e/n*350,f=r/n*350;let a=Math.atan2(this.vy,this.vx),c=Math.atan2(f,d),l=c-a;for(;l>Math.PI;)l-=Math.PI*2;for(;l<-Math.PI;)l+=Math.PI*2;const x=1*t;Math.abs(l)<x?a=c:a+=Math.sign(l)*x,this.vx=Math.cos(a)*350,this.vy=Math.sin(a)*350}}this.x+=this.vx*t,this.y+=this.vy*t}}class E{constructor(t,s,i,h){this.x=t,this.y=s,this.text=i,this.color=h,this.life=1,this.active=!0,this.vy=-50}update(t){this.life-=t,this.y+=this.vy*t,this.life<=0&&(this.active=!1)}}class u{static checkCollision(t,s){const i=Math.max(s.x,Math.min(t.x,s.x+s.width)),h=Math.max(s.y,Math.min(t.y,s.y+s.height)),e=t.x-i,r=t.y-h;return e*e+r*r<t.radius*t.radius}static checkCircleCollision(t,s){const i=t.x-s.x,h=t.y-s.y;return Math.sqrt(i*i+h*h)<t.radius+s.radius}static resolveCollision(t,s){return this.checkCollision(t,s)}}class b{constructor(){this.canvas=document.getElementById("game-canvas"),this.ctx=this.canvas.getContext("2d"),this.width=window.innerWidth,this.height=window.innerHeight,this.resize(),window.addEventListener("resize",()=>this.resize()),this.input=new T,this.renderer=new C(this.ctx,this.width,this.height),this.startScreen=document.getElementById("start-screen"),this.tutorialScreen=document.getElementById("tutorial-screen"),this.gameOverScreen=document.getElementById("game-over-screen"),this.startBtn=document.getElementById("start-btn"),this.tutorialBtn=document.getElementById("tutorial-btn"),this.closeTutorialBtn=document.getElementById("close-tutorial-btn"),this.restartBtn=document.getElementById("restart-btn"),this.startBtn.addEventListener("click",()=>this.start()),this.tutorialBtn.addEventListener("click",()=>this.showTutorial()),this.closeTutorialBtn.addEventListener("click",()=>this.hideTutorial()),this.restartBtn.addEventListener("click",()=>this.restart()),this.reset()}showTutorial(){this.startScreen.classList.add("hidden"),this.tutorialScreen.classList.remove("hidden")}hideTutorial(){this.tutorialScreen.classList.add("hidden"),this.startScreen.classList.remove("hidden")}reset(){this.player=new k(this.width/2,this.height-100),this.blocks=[],this.items=[],this.projectiles=[],this.floatingTexts=[],this.score=0,this.spawnTimer=0,this.baseScrollSpeed=60,this.scrollSpeed=this.baseScrollSpeed,this.spawnInterval=1.33,this.gameTime=60,this.phase="scavenge",this.boss=null,this.lastTime=0,this.isRunning=!1,this.updateHUD(),this.renderer.clear(),this.renderer.drawPlayer(this.player)}resize(){this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=this.width,this.canvas.height=this.height,this.renderer&&this.renderer.resize(this.width,this.height)}start(){this.isRunning||(this.startScreen.classList.add("hidden"),this.gameOverScreen.classList.add("hidden"),this.isRunning=!0,this.phase="scavenge",this.lastTime=performance.now(),this.spawnBlock(),requestAnimationFrame(this.loop.bind(this)))}restart(){this.reset(),this.start()}loop(t){if(!this.isRunning)return;this.lastTime||(this.lastTime=t);let s=(t-this.lastTime)/1e3;this.lastTime=t,s>.1&&(s=.1),this.update(s),this.draw(),requestAnimationFrame(this.loop.bind(this))}update(t){if(this.player.update(t,this.input),this.phase==="scavenge"){const s=this.player.atk+this.player.speed/100+this.player.def;this.scrollSpeed=this.baseScrollSpeed+s*8}if(this.spawnTimer+=t,this.spawnTimer>this.spawnInterval&&(this.spawnBlock(),this.spawnTimer=0),this.blocks.forEach(s=>{s.update(t,this.scrollSpeed),s.active&&u.checkCollision(this.player,s)&&this.handleCollision(this.player,s)}),this.player.y>this.height-this.player.radius&&this.gameOver(),this.items.forEach(s=>{s.update(t,this.scrollSpeed),s.active&&u.checkCircleCollision(this.player,s)&&this.collectItem(s)}),this.projectiles.forEach(s=>{s.update(t,this.player),this.blocks.forEach(i=>{i.active&&u.checkCollision(s,i)&&(i.hp-=s.type==="beam"?.5:1,i.hp<=0&&(i.active=!1,this.spawnItem(i.x+i.width/2,i.y+i.height/2,i.type),this.score+=100),s.type!=="beam"&&(s.active=!1))}),this.boss&&this.phase==="boss"&&s.type!=="boss_bullet"&&s.type!=="homing_missile"&&u.checkCollision(s,{x:this.boss.x,y:this.boss.y,width:this.boss.width,height:this.boss.height})&&(this.boss.hp-=s.type==="beam"?.5:1,this.boss.hp<=0&&this.gameWin(),s.type!=="beam"&&(s.active=!1))}),this.floatingTexts.forEach(s=>s.update(t)),this.player.hasSword){const s=this.player.x+Math.cos(this.player.swordAngle)*this.player.swordRadius,i=this.player.y+Math.sin(this.player.swordAngle)*this.player.swordRadius,h=this.player.swordSize;this.blocks.forEach(e=>{e.active&&u.checkCollision({x:s,y:i,radius:h},e)&&(e.hp=0,e.active=!1,this.spawnItem(e.x+e.width/2,e.y+e.height/2,e.type),this.score+=100,this.spawnFloatingText(e.x,e.y,"SLASH!","#ffaa00"))}),this.projectiles.forEach(e=>{e.active&&(e.type==="boss_bullet"||e.type==="homing_missile")&&u.checkCircleCollision({x:s,y:i,radius:h},e)&&(e.active=!1,this.spawnFloatingText(e.x,e.y,"BLOCK!","#ffaa00"))})}if(this.player.isAttacking&&this.player.hasBeam&&this.fireWeapon(t),this.blocks=this.blocks.filter(s=>s.active&&s.y<this.height+100),this.items=this.items.filter(s=>s.active&&s.y<this.height+100),this.projectiles=this.projectiles.filter(s=>s.active&&s.y>-100&&s.y<this.height),this.floatingTexts=this.floatingTexts.filter(s=>s.active),this.updateHUD(),this.phase==="scavenge")this.gameTime-=t,this.gameTime<=0&&this.startBossPhase();else if(this.phase==="boss"&&this.boss){if(this.boss.update(t,this.player),this.boss.shouldAttack()){const i=this.boss.getAttackProjectile(this.player.x,this.player.y);this.projectiles.push(new g(i.x,i.y,i.vx,i.vy,"boss_bullet"))}this.boss.pollProjectiles().forEach(i=>{this.projectiles.push(new g(i.x,i.y,i.vx,i.vy,i.type))}),u.checkCollision(this.player,{x:this.boss.x,y:this.boss.y,width:this.boss.width,height:this.boss.height})&&(this.player.isAttacking?(this.boss.hp-=this.player.atk,this.boss.hp<=0&&this.gameWin()):this.player.invincible||(this.player.hp-=1,this.player.hp<=0&&this.gameOver())),this.projectiles.forEach(i=>{(i.type==="boss_bullet"||i.type==="homing_missile")&&i.active&&u.checkCircleCollision(this.player,i)&&(this.player.invincible||(this.player.hp-=5,this.player.hp<=0&&this.gameOver()),i.active=!1)})}}startBossPhase(){this.phase="boss",this.blocks=[],this.items=[],this.boss=new S(this.width/2-50,50)}gameWin(){this.isRunning=!1,document.getElementById("game-over-screen").classList.remove("hidden"),document.querySelector("#game-over-screen h1").innerText="YOU WIN!",document.getElementById("final-score").innerText=this.score}spawnBlock(){if(this.phase!=="scavenge")return;const t=this.player.radius*4,s=Math.floor(this.width/t),i=(this.width-s*t)/2;if(s<=0)return;let h=Math.floor(Math.random()*s);s===1&&Math.random()>.5&&(h=-1);let e=-1;Math.random()>.5&&s>2&&(e=Math.floor(Math.random()*s));for(let r=0;r<s;r++){if(r===h||r===e)continue;const n=i+r*t,d=-t,f=Math.random()>.8?"hard":Math.random()>.8?"resource":"normal";this.blocks.push(new P(n,d,t,t,f))}}gameOver(){this.isRunning=!1,document.getElementById("game-over-screen").classList.remove("hidden"),document.querySelector("#game-over-screen h1").innerText="GAME OVER",document.getElementById("final-score").innerText=this.score}handleCollision(t,s){if(t.invincible||t.isShaking&&!t.isCharging&&!t.isAttacking||t.canBreakOnContact){s.hp-=t.atk,s.hp<=0?(s.active=!1,this.spawnItem(s.x+s.width/2,s.y+s.height/2,s.type),this.score+=100):t.y+=2;return}if(t.isAttacking){const i=t.atk+t.chargePower;s.hp-=i,t.chargePower=Math.max(0,t.chargePower-3),s.hp<=0?(s.active=!1,this.spawnItem(s.x+s.width/2,s.y+s.height/2,s.type),this.score+=100):(t.isAttacking=!1,t.y+=10)}else t.y+=5}spawnItem(t,s,i){let h="hp";if(i==="resource"){const e=Math.random();e<.2?h="atk":e<.4?h="spd":e<.6?h="def":h="beam"}else if(i==="hard")Math.random()>.7?h="sword":h="atk";else{const e=Math.random();if(e>.95)h="invincible";else if(e>.9)h="beam";else if(e>.7)h="hp";else return}this.items.push(new B(t,s,h))}collectItem(t){t.active=!1;let s="",i=t.color;t.type==="invincible"?(this.player.invincible=!0,this.player.invincibleTimer=5,s="INVINCIBLE!"):t.type==="beam"?(this.player.upgrade("beam"),s="BEAM UNLOCKED!"):t.type==="sword"?(this.player.upgrade("sword"),s="SWORD EQUIPPED!"):(this.player.upgrade(t.type),s=`+${t.type.toUpperCase()}`,t.type==="hp"&&(s="+20 HP")),this.spawnFloatingText(t.x,t.y,s,i),this.score+=50}fireWeapon(t){this.player.weaponTimer+=t,this.player.weaponTimer>.05&&(this.projectiles.push(new g(this.player.x,this.player.y-20,0,-800,"beam")),this.player.weaponTimer=0)}updateHUD(){document.getElementById("score-val").innerText=this.score,document.getElementById("time-val").innerText=Math.ceil(this.gameTime),document.getElementById("hp-val").innerText=Math.max(0,Math.floor(this.player.hp)),document.getElementById("atk-val").innerText=this.player.atkCount,document.getElementById("spd-val").innerText=this.player.spdCount,document.getElementById("def-val").innerText=this.player.defCount}draw(){this.renderer.clear(),this.blocks.forEach(t=>{t.active&&this.renderer.drawBlock(t)}),this.items.forEach(t=>{t.active&&this.renderer.drawItem(t)}),this.projectiles.forEach(t=>{t.active&&this.renderer.drawProjectile(t)}),this.floatingTexts.forEach(t=>{t.active&&this.renderer.drawFloatingText(t)}),this.boss&&this.phase==="boss"&&this.renderer.drawBoss(this.boss),this.renderer.drawPlayer(this.player)}spawnFloatingText(t,s,i,h){this.floatingTexts.push(new E(t,s,i,h))}}window.addEventListener("DOMContentLoaded",()=>{new b});
